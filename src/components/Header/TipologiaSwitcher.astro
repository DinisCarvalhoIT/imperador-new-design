---
import { getLangFromUrl, useTranslations } from "@/i18n/utils";

// Get current language
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Define tipologia options with their respective page paths
const tipologias = [
  { label: "T1", path: lang === "pt" ? "/pt/t1" : "/t1" },
  { label: "T2", path: lang === "pt" ? "/pt/t2" : "/t2" },
  { label: "T3", path: lang === "pt" ? "/pt/t3" : "/t3" },
];

// Generate unique ID for this instance
const uniqueId = Math.random().toString(36).substr(2, 9);
---

<script define:vars={{ uniqueId }}>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("TipologiaSwitcher initializing with uniqueId:", uniqueId);

    const dropdownButton = document.getElementById(
      "tipologiaButton-" + uniqueId
    );
    const dropdownList = document.getElementById("tipologiaList-" + uniqueId);
    const dropdownIcon = document.getElementById("tipologiaIcon-" + uniqueId);

    console.log("Found elements:", {
      dropdownButton: !!dropdownButton,
      dropdownList: !!dropdownList,
      dropdownIcon: !!dropdownIcon,
    });

    if (!dropdownButton || !dropdownList || !dropdownIcon) {
      console.error("Dropdown elements not found for uniqueId:", uniqueId);
      return;
    }

    dropdownButton.addEventListener("click", () => {
      const isHidden = dropdownList.classList.contains("hidden");
      if (isHidden) {
        dropdownList.classList.remove("hidden");
        dropdownList.classList.remove("opacity-0");
        dropdownList.classList.remove("scale-95");
        dropdownList.classList.add("opacity-100");
        dropdownList.classList.add("scale-100");
        dropdownIcon.classList.add("rotate-180");
      } else {
        dropdownList.classList.add("hidden");
        dropdownList.classList.add("opacity-0");
        dropdownList.classList.add("scale-95");
        dropdownList.classList.remove("opacity-100");
        dropdownList.classList.remove("scale-100");
        dropdownIcon.classList.remove("rotate-180");
      }
    });

    document.addEventListener("click", (event) => {
      if (!dropdownButton.contains(event.target) && !dropdownList.contains(event.target)) {
        dropdownList.classList.add("hidden");
        dropdownList.classList.add("opacity-0");
        dropdownList.classList.add("transform");
        dropdownList.classList.add("scale-95");
        dropdownIcon.classList.remove("rotate-180");
      }
    });

    dropdownList.addEventListener("click", (event) => {
      const targetElement = event.target;

      // Only handle clicks on the link elements, not the list items
      if (targetElement.tagName === "A" || targetElement.closest("a")) {
        // Close the dropdown immediately
        dropdownList.classList.add("hidden");
        dropdownList.classList.add("opacity-0");
        dropdownList.classList.add("transform");
        dropdownList.classList.add("scale-95");
        dropdownIcon.classList.remove("rotate-180");

        // Let the default link navigation happen
        return true;
      }
    });

    const updateScrollState = () => {
      const dropdownList = document.getElementById("tipologiaList-" + uniqueId);
      if (!dropdownList) return;

      const items = dropdownList.querySelectorAll("li");
      const isScrolled = window.scrollY > 50;

      if (isScrolled) {
        // scrolled → blue background, remove borders
        dropdownList.classList.remove("bg-transparent");
        dropdownList.classList.add("bg-[#0b1d26db]");
        items.forEach((li) => {
          li.classList.remove("border-white");
          li.classList.remove("border");
        });
      } else {
        // top → transparent background, white borders
        dropdownList.classList.remove("bg-[#0b1d26db]");
        dropdownList.classList.add("bg-transparent");
        items.forEach((li) => {
          li.classList.add("border");
          li.classList.add("border-white");
        });
      }
    };

    // Initialize on load
    updateScrollState();

    // Update on scroll
    window.addEventListener("scroll", updateScrollState, { passive: true });
  }); // End of DOMContentLoaded
</script>

<div class="relative z-30" data-unique-id={uniqueId}>
  <button
    id={"tipologiaButton-" + uniqueId}
    type="button"
    class="bg-transparent m-0 font-montserrat font-medium flex items-center gap-x-1 header-item text-white cursor-pointer relative group pb-1"
  >
    <span>{t("header.tipologias")}</span>
    <svg
      id={"tipologiaIcon-" + uniqueId}
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="lucide lucide-chevron-down h-4 w-4 opacity-100 transition-transform duration-300"
      aria-hidden="true"
    >
      <path d="m6 9 6 6 6-6"></path>
    </svg>
    <span
      class="absolute bottom-0 left-0 w-0 h-0.5 bg-linear-to-r from-yellow-400 via-amber-500 to-yellow-600 transition-all duration-300 ease-out group-hover:w-full"
    ></span>
  </button>
  <div>
    <ul
      id={"tipologiaList-" + uniqueId}
      class="absolute left-0 bg-transparent rounded-none w-[120px] mt-1 hidden z-20 transition-all duration-300 opacity-0 transform scale-95 font-medium text-sm space-y-2 p-2 shadow-lg"
    >
      {
        tipologias.map((tipologia) => {
          return (
            <a href={tipologia.path}>
              <li class="w-full h-10 px-4 rounded-none flex items-center justify-center cursor-pointer transition-all duration-200 hover:bg-[#2f577a]/10 hover:shadow-sm text-white font-playfairDisplay font-medium text-lg tracking-wide border border-white">
                {tipologia.label}
              </li>
            </a>
          );
        })
      }
    </ul>
  </div>
</div>
