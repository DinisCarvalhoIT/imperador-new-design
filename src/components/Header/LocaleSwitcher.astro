---
import { useTranslatedPath, getLangFromUrl } from "@/i18n/utils";
import { defaultLang } from "@/i18n/ui";
import { Image } from "astro:assets";

// Import flag SVGs
import gbFlag from "../../../public/flags/gb.svg";
import ptFlag from "../../../public/flags/pt.svg";

const languages = {
  en: "gb",
  pt: "pt",
};

const labels = {
  en: "EN",
  pt: "PT",
};

const flagImages = {
  gb: gbFlag,
  pt: ptFlag,
};

// Derive current language from URL, falling back to the configured default
const derivedLang = getLangFromUrl(Astro.url);
const currentLang = (derivedLang ?? defaultLang) as "en" | "pt";
const currentPath = Astro.url.pathname;

// Remove locale prefix if it exists
const pathWithoutLocale = currentPath.replace(/^\/(en|pt)/, "") || "/";

// Get current path without locale prefix
const getCurrentPath = () => {
  const pathSplit = currentPath.split("/");
  if (pathSplit[1] === "en" || pathSplit[1] === "pt") {
    pathSplit.splice(1, 1);
  }
  return pathSplit.join("/") || "/";
};

const translatePath = useTranslatedPath(currentLang);

// Generate unique ID for this instance
const uniqueId = Math.random().toString(36).substr(2, 9);
---

<script define:vars={{ uniqueId }}>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("LocaleSwitcher initializing with uniqueId:", uniqueId);

    const dropdownButton = document.getElementById(
      "dropdownButton-" + uniqueId
    );
    const dropdownList = document.getElementById("dropdownList-" + uniqueId);
    const dropdownIcon = document.getElementById("dropdownIcon-" + uniqueId);
    const selectedLabel = document.getElementById("selectedLabel-" + uniqueId);
    if (!dropdownButton || !dropdownList || !selectedLabel || !dropdownIcon) {
      console.error("Dropdown elements not found for uniqueId:", uniqueId);
      return;
    }

    dropdownButton.addEventListener("click", () => {
      dropdownList.classList.toggle("hidden");
      dropdownList.classList.toggle("opacity-0");
      dropdownList.classList.toggle("transform");
      dropdownList.classList.toggle("scale-95");
      dropdownIcon.classList.toggle("rotate-180");
    });

    document.addEventListener("click", (event) => {
      if (!dropdownButton.contains(event.target)) {
        dropdownList.classList.add("hidden");
        dropdownList.classList.add("opacity-0");
        dropdownList.classList.add("transform");
        dropdownList.classList.add("scale-95");
        dropdownIcon.classList.remove("rotate-180");
      }
    });

    dropdownList.addEventListener("click", (event) => {
      const targetElement = event.target;

      // Only handle clicks on the link elements, not the list items
      if (targetElement.tagName === "A" || targetElement.closest("a")) {
        // Close the dropdown immediately
        dropdownList.classList.add("hidden");
        dropdownList.classList.add("opacity-0");
        dropdownList.classList.add("transform");
        dropdownList.classList.add("scale-95");
        dropdownIcon.classList.remove("rotate-180");

        // Let the default link navigation happen
        return true;
      }
    });

    const updateScrollState = () => {
      const dropdownList = document.getElementById("dropdownList-" + uniqueId);
      if (!dropdownList) return;

      const items = dropdownList.querySelectorAll("li");
      const isScrolled = window.scrollY > 50;

      if (isScrolled) {
        // scrolled → blue background, remove borders
        dropdownList.classList.remove("bg-transparent");
        dropdownList.classList.add("bg-[#0b1d26db]");
        items.forEach((li) => {
          li.classList.remove("border-white");
          li.classList.remove("border");
        });
      } else {
        // top → transparent background, white borders
        dropdownList.classList.remove("bg-[#0b1d26db]");
        dropdownList.classList.add("bg-transparent");
        items.forEach((li) => {
          li.classList.add("border");
          li.classList.add("border-white");
        });
      }
    };

    // Initialize on load
    updateScrollState();

    // Update on scroll
    window.addEventListener("scroll", updateScrollState, { passive: true });
  }); // End of DOMContentLoaded
</script>
<form class="z-30" data-unique-id={uniqueId}>
  <div class="relative">
    <button
      id={"dropdownButton-" + uniqueId}
      type="button"
      class="bg-transparent m-0 font-montserrat text-sm flex items-center gap-x-1 header-item text-white cursor-pointer"
    >
      <div id={"selectedLabel-" + uniqueId} class="z-20 flex items-center">
        <Image
          src={flagImages[languages[currentLang] as keyof typeof flagImages]}
          alt={`${labels[currentLang]} flag`}
          class="w-6 h-6 rounded-full object-cover"
          loading="eager"
          width={24}
          height={24}
        />
      </div>
      <svg
        id={"dropdownIcon-" + uniqueId}
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="lucide lucide-chevron-down h-4 w-4 opacity-100 transition-transform duration-300"
        aria-hidden="true"
      >
        <path d="m6 9 6 6 6-6"></path>
      </svg>
    </button>
    <div>
      <ul
        id={"dropdownList-" + uniqueId}
        class="absolute left-0 rounded-none w-full mt-1 hidden z-20 transition-all duration-300 opacity-0 transform scale-95 font-medium lg:text-xl text-sm bg-transparent"
      >
        {
          Object.entries(languages).filter(([lang]) => lang !== currentLang as keyof typeof languages).map(([lang, flagCode]) => {
            const langKey = lang as keyof typeof labels;
            return (
              <a href={translatePath(getCurrentPath(), lang)}>
                <li class="p-2 flex items-center justify-center cursor-pointer bg-transparent border rounded-none border-white transition-all duration-200 hover:bg-[#2f577a]/10 hover:shadow-sm">
                  <Image
                    src={flagImages[flagCode as keyof typeof flagImages]}
                    alt={`${labels[langKey]} flag`}
                    class="w-6 h-6 rounded-full object-cover"
                    loading="eager"
                    width={24}
                    height={24}
                  />
                </li>
              </a>
            );
          })
        }
      </ul>
    </div>
  </div>
</form>
